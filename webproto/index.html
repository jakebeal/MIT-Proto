<!DOCTYPE html>
<html lang="en">
<head>
<title>WebProto IDE</title>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
<style type="text/css" media="screen">
   body,html{width:100%;height:100%;padding:0;margin:0;}
   #main{
      color: #fff;
      font-family:Monospace;
      font-size:13px;
      background-color: #050505;
      float: right;
      position: absolute;
      top:100px;
      bottom: 38px;
      right: 0;
      left: 50%;
      overflow: hidden;
   }
   .sidebar{
      color: #fff;
      font-family:Monospace;
      font-size:13px;
      background-color: #050505;
      width: 50%;
      float: left;
      position: absolute;
      top:100px;
      bottom: 38px;
      overflow: hidden;
   }
   #footer{
      color: #fff;
      font-family:Monospace;
      font-size:15px;
      background-color: #050505;
      width:100%;
      height: 38px;
      bottom:0;
      position:absolute;
   }
   #header{
      color: #fff;
      font-family:Monospace;
      font-size:13px;
      background-color: #050505;
      width:100%;
      height: 100px;
   }
   #dragbar{
      background-color: gray;
      height:100%;
      float: right;
      width: 6px;
      cursor: col-resize;
   }
   #editor { 
      font-size:20px;
      position: absolute;
      top: 0;
      right: 0;
      bottom: 0;
      left: 0;
   }
   #container {
      position: absolute;
      top: 0;
      right: 0;
      bottom: 0;
      left: 0;
      height: 99%;
      width: 99%;
   }
</style>

<link rel="stylesheet" href="http://code.jquery.com/ui/1.10.3/themes/smoothness/jquery-ui.css" />
<link rel="stylesheet" type="text/css" href="css/jquery.jnotify.css">

</head>
<body>

   <div id="fullpage">
      <div id="header">
         <img height="100px" src="http://proto.bbn.com/commons/sites/default/files/commons_connect_logo.png"/> 
         <div id="headerbuttons" style="float: right;">
            <table> <tr>
               <td>
                  <button id="runProgramButton">Run Program</button> 
               </td>
               <td>
                  <button id="settingsButton">Settings</button> 
               </td>
               <td>
                  <button id="linkButton">Create a Link</button> 
               </td>
            </tr> </table>
         </div>
      </div>
      <div id="sidebar" class="sidebar">
         <span id="position"></span>
         <div id="dragbar"></div>
         <div id="container"> </div>
      </div>


      <div id="main">
         <div id="editor"> </div>
      </div>

      <div id="footer"> Proto is a free and open-source project.  Go to <a href="http://proto.bbn.com">proto.bbn.com</a> to learn more.</div>

   </div>

   <div id="settingsDialog" title="Settings">
      Number of Devices:
      <input id="numDevicesInput" class="positive-integer" type="text" /><br />
      Radius:
      <input id="radiusInput" class="positive-integer" type="text" /><br />
      Step Size:
      <input id="stepInput" class="positive-integer" type="text" /><br />
      Show Network Topology:
      <input id="topologyInput" type="checkbox" /><br />
   </div>
   
   <div id="linkDialog" title="Link">
      Link:
      <input id="linkInput" type="text" /><br />
   </div>

<script src="js/jquery-2.0.2.min.js"></script>
<script src="js/jquery.numeric.js"></script>
<script src="js/jquery-ui.js"></script>
<script src="js/jquery.jnotify.min.js"></script>
<script src="js/three.min.js"></script>
<script src="js/spatialcomputer.js"></script>
<script src="js/webproto.js"></script>
<script src="js/TrackballControls.js"></script>
<script src="js/stats.min.js"></script>
<script src="js/protosim.js"></script>
<script src="ace/ace.js" type="text/javascript" charset="utf-8"></script>
<script>
   var script, editor;

   function getURLParameter(name) {
      return decodeURIComponent((new RegExp('[?|&]' + name + '=' + '([^&;]+?)(&|#|;|$)').exec(location.search)||[,""])[1].replace(/\+/g, '%20'))||null;
   }

   $(document).ready(function() {

      // fixing the stupid checkbox behavior
      (function( $ ) {
         $.fn.checked = function(value) {
            if(value === true || value === false) {
               // Set the value of the checkbox
               $(this).each(function(){ this.checked = value; });
            } 
            else if(value === undefined || value === 'toggle') {
               // Toggle the checkbox
               $(this).each(function(){ this.checked = !this.checked; });
            }

            return this;
         };
      })( jQuery );

      var prg = getURLParameter('program');
      if(prg) {
         $('#editor').text(prg);
      }

      $(".numeric").numeric();
      $(".integer").numeric(false, function() { alert("Integers only"); this.value = ""; this.focus(); });
      $(".positive").numeric({ negative: false }, function() { alert("No negative values"); this.value = ""; this.focus(); });
      $(".positive-integer").numeric({ decimal: false, negative: false }, function() { alert("Positive integers only"); this.value = ""; this.focus(); });

      $( "#settingsDialog" ).dialog({
         autoOpen: false,
         show: {
            effect: "slide",
            duration: 500
         },
         hide: {
            effect: "slide",
            duration: 500
         }
      });

      $("#linkDialog").dialog({
         autoOpen: false,
         show: {
            effect: "slide",
            duration: 500
         },
         hide: {
            effect: "slide",
            duration: 500
         }
      });

      $("#linkButton").click(function() {
         $("#linkDialog").dialog( "open" );
         $("#linkInput").val(window.location.host + window.location.pathname + "?program=" + encodeURIComponent(editor.getValue()));
      });

      $("#settingsButton").click(function() {
         $("#settingsDialog").dialog( "open" );
         $("#numDevicesInput").val(simulatorSettings.numDevices);
         $("#radiusInput").val(simulatorSettings.radius);
         $("#topologyInput").checked(simulatorSettings.drawEdges);
         $("#stepInput").val(simulatorSettings.stepSize);
      });

      $("#numDevicesInput").change(function() {
         simulatorSettings.numDevices = parseInt($("#numDevicesInput").val());
      });

      $("#radiusInput").change(function() {
         simulatorSettings.radius = parseInt($("#radiusInput").val());
         if(spatialComputer && spatialComputer.devices) {
            $.each(spatialComputer.devices, function(index, device) {
               device.machine.radius = simulatorSettings.radius;
            });
         }
      });
      
      $("#topologyInput").change(function() {
         simulatorSettings.drawEdges = $("#topologyInput").is(':checked');
      });
      
      $("#stepInput").change(function() {
         simulatorSettings.stepSize = parseInt($("#stepInput").val());
      });
      
      editor = ace.edit("editor");
      editor.setTheme("ace/theme/monokai");
      editor.getSession().setMode("ace/mode/proto");

      $( "#runProgramButton" ).click(function() {
         runProgram(editor);
      });

      function runProgram(editor) {
         var program = "";
         var editorLines= editor.getValue().split('\n');
         $.each(editorLines, function(lineNumber, line) {
            var commentCharAt = line.indexOf(';');
            if(commentCharAt >= 0) {
               line = line.substring(0, commentCharAt);
            }
            line = $.trim(line);
            if(line.length > 0) {
               program += line + ' ';
            }
         });
         runSimulator(program);
      }

      function runSimulator(program) {
         // Hide the IDE
         //$('#editor').hide();

         // Compile the Script
         script = new Module.Script();
         $.ajax({
            type: 'GET',
            dataType: "json",
            async: false,
            url: '/cgi-bin/webcompiler',
            data: { "program" : program },
            success: function(data) {
               console.log(data.script);

               // Grab key events
               $(document).keydown(keyHandlers);

               // Add the compiler's response to a script
               $.each(data.script, function(index, value) {
                  script.push_back(value);
               });

               // Prevent further code editing
               editor.setReadOnly(true);

               // Start the Simulator
               init();
               animate();
            },
            error: function(err) {
               $.jnotify("There was an error processing the Proto script, please check it and try again", "error");
               if(err && err.responseText) {
                  $.jnotify(err.responseText, "error");
               }
               console.log(err);
            }
         }); // end ajax()
      } // end runSimulator()

      // Dragging dragbar
      $('#dragbar').mousedown(function(e){
         e.preventDefault();
         $(document).mousemove(function(e){
            //$('#position').html(e.pageX +', '+ e.pageY);
            $('#sidebar').css("width",e.pageX+2);
            $('#main').css("left",e.pageX+2);
         })
      });
      $(document).mouseup(function(e){
         $(document).unbind('mousemove');
      });

      // Execute code by hitting Ctrl-M
      editor.commands.addCommand({
         name: 'myCommand',
         bindKey: {win: 'Ctrl-M',  mac: 'Ctrl-M'},
         exec: function(editor) {
            runProgram(editor);
         },
         readOnly: false // false if this command should not apply in readOnly mode
      });

   });

</script>
</body>
</html>
